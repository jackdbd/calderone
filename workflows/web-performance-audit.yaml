main:
  params: [args]
  steps:

    # https://docs.webpagetest.org/api/reference/#full-list-of-parameters
    - assign_defaults:
        assign:
          - private: 1
          - profiler: 0
          - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - timeline: 0
          - video: 0

    - retrieve_wpt_api_key:
        call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
        args:
          project_id: ${project_id}
          secret_id: "WEB_PAGE_TEST_API_KEY"
          version: "1"
        result: wpt_api_key

    - retrieve_wpt_pingback_url:
        call: googleapis.secretmanager.v1.projects.secrets.versions.accessString
        args:
          project_id: ${project_id}
          secret_id: "WEB_PAGE_TEST_PINGBACK_URL"
          version: "latest"
        result: pingback

    - assign_private:
        switch:
          - condition: ${"is_audit_public" in args and args.is_audit_public}
            assign:
              - private: 0

    - assign_profiler:
        switch:
          - condition: ${"record_chrome_performance_trace" in args and args.record_chrome_performance_trace}
            assign:
              - profiler: 1

    - assign_timeline:
        switch:
          - condition: ${"record_devtools_timeline" in args and args.record_devtools_timeline}
            assign:
              - timeline: 1

    - assign_video:
        switch:
          - condition: ${"record_filmstrip" in args and args.record_filmstrip}
            assign:
              - video: 1

    - assign_required_args:
        switch:
          - condition: ${"url" in args}
            assign:
              - audit_label: ${args.label}
              - audit_location: ${args.location}
              - audit_runs: ${args.runs}
              - audit_url: ${args.url}

    # uncomment this workflow step when debugging
    # - return_optional_args:
    #     return: {
    #       "pingback": "${pingback}",
    #       "private": "${private}",
    #       "profiler": "${profiler}",
    #       "timeline": "${timeline}",
    #       "video": "${video}"
    #     }

    - run_wpt_test:
        call: http.post
        args:
          url: https://webpagetest.org/runtest.php
          query:
            f: json
            k: ${wpt_api_key}
            label: ${audit_label}
            location: ${audit_location}
            pingback: ${pingback}
            private: ${private}
            profiler: ${profiler}
            runs: ${audit_runs}
            timeline: ${timeline}
            url: ${audit_url}
            video: ${video}
        result: wpt_result

    - return_value:
        return: ${wpt_result.body}